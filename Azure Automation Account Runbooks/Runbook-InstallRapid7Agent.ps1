$connectionName = "AzureRunAsConnection"
$servicePrincipalConnection = Get-AutomationConnection -Name $connectionName
$logonAttempt = 0
$logonResult = $False
while(!($connectionResult) -And ($logonAttempt -le 10))
{
    $LogonAttempt++
    #Logging in to Azure...
    $connectionResult = Connect-AzAccount `
                           -ServicePrincipal `
                           -Tenant $servicePrincipalConnection.TenantId `
                           -ApplicationId $servicePrincipalConnection.ApplicationId `
                           -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint
    Start-Sleep -Seconds 30
}
#### Need to make the below come from central location/repository
#$rapid7linuxzip = "\\location\azure_config.zip"
#$binary = Get-Content -Path $rapid7linuxzip -Encoding Byte
#$base64 = [Convert]::ToBase64String($binary)
$base64 = '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'

$params = @{"configzip" = $base64}

### Target Running Machines
$AllVM = Get-AZVM -Status
$RunningVM = $AllVM | ?{$($_.PowerState -match "running")}


foreach ($vm in $RunningVM) {
    
    #see if insight agent installed.
    Write-Output "Inspecting if Rapid7 Extension installed on $($vm.Name)"
    $InsightAgentInstall = Get-AzVMExtension -ResourceGroupName $vm.resourcegroupname -VMName $vm.Name | ?{$_.Name -like "InsightAgent*"}
    

    if ($Null -eq $InsightAgentInstall) {    
        try{
            #check what OS is installed
            if ($vm.StorageProfile.osDisk.OsType -match "Windows"){
                $InstallName = "InsightAgentWindows"
            }
            elseif ($vm.StorageProfile.osDisk.OsType -match "Linux"){
                $InstallName = "InsightAgentLinux"
            }
            else {
                Write-Output "$($vm.Name) does not currently have a support Rapid 7 Agent Install"
                exit
            }
            
            Write-Output "Installing Rapid7 Extension on $($vm.Name)"
            Set-AzVMExtension `
                -VMName $vm.Name `
                -ResourceGroupName $vm.resourcegroupname `
                -Name $InstallName `
                -Publisher "Rapid7.InsightPlatform" `
                -ExtensionType $InstallName `
                -TypeHandlerVersion 2.0 `
                -Location $vm.location `
                -ProtectedSettings $params
        }
        catch{
            throw "This action failed $($_.exception)"
        }
    }
    else {
        #It's installed, don't do anything
        Write-Output "Skipping $($vm.Name) - Rapid7 Extension already installed"
    }     
}